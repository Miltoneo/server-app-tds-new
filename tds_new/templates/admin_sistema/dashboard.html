{% extends 'admin_sistema/base_admin.html' %}

{% block content %}
<div class="container-fluid">
    <!-- Alerta de permissão -->
    <div class="alert alert-warning mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Área Administrativa:</strong> Você está visualizando dados de <strong>TODAS as contas</strong> do sistema.
        Tome cuidado ao realizar operações nesta interface.
    </div>

    <!-- Métricas Globais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="bi bi-building fs-1 text-primary"></i>
                    <h2 class="mt-2">{{ total_contas }}</h2>
                    <p class="text-muted mb-0">Contas Ativas</p>
                    <small class="text-muted">{{ contas_com_gateway }} com gateways</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="bi bi-hdd-network fs-1 text-success"></i>
                    <h2 class="mt-2">{{ total_gateways }}</h2>
                    <p class="text-muted mb-0">Gateways</p>
                    <small class="text-success">{{ gateways_online }} online</small> · 
                    <small class="text-danger">{{ gateways_offline }} offline</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="bi bi-cpu fs-1 text-info"></i>
                    <h2 class="mt-2">{{ total_dispositivos }}</h2>
                    <p class="text-muted mb-0">Dispositivos</p>
                    <small class="text-info">{{ dispositivos_ativos }} ativos</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="bi bi-shield-check fs-1 text-warning"></i>
                    <h2 class="mt-2">{{ certificados_validos }}</h2>
                    <p class="text-muted mb-0">Certificados Válidos</p>
                    {% if certificados_renova_breve > 0 %}
                    <small class="text-warning">{{ certificados_renova_breve }} a renovar</small>
                    {% else %}
                    <small class="text-muted">{{ certificados_expirados }} expirados</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas Detalhadas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <strong><i class="bi bi-bar-chart me-2"></i>Status de Gateways</strong>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-success">{{ gateways_online }}</h4>
                            <p class="text-muted small">Online</p>
                        </div>
                        <div class="col-4">
                            <h4 class="text-danger">{{ gateways_offline }}</h4>
                            <p class="text-muted small">Offline</p>
                        </div>
                        <div class="col-4">
                            <h4 class="text-secondary">{{ gateways_nunca_conectados }}</h4>
                            <p class="text-muted small">Nunca Conectado</p>
                        </div>
                    </div>
                    <div class="progress" style="height: 25px;">
                        {% widthratio gateways_online total_gateways 100 as online_percent %}
                        {% widthratio gateways_offline total_gateways 100 as offline_percent %}
                        {% widthratio gateways_nunca_conectados total_gateways 100 as nunca_percent %}
                        
                        <div class="progress-bar bg-success" style="width: {{ online_percent }}%">{{ online_percent }}%</div>
                        <div class="progress-bar bg-danger" style="width: {{ offline_percent }}%">{{ offline_percent }}%</div>
                        <div class="progress-bar bg-secondary" style="width: {{ nunca_percent }}%">{{ nunca_percent }}%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <strong><i class="bi bi-trophy me-2"></i>Top 5 Contas (Mais Gateways)</strong>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Conta</th>
                                <th class="text-end">Gateways</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conta in top_contas %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ conta.nome_fantasia }}</td>
                                <td class="text-end"><strong class="text-primary">{{ conta.num_gateways }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nenhuma conta com gateways</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Atividade Recente -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <strong><i class="bi bi-clock-history me-2"></i>Atividade Recente (Últimos 7 dias)</strong>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <i class="bi bi-hdd-network fs-2 text-success"></i>
                            <h4 class="mt-2">{{ gateways_recentes }}</h4>
                            <p class="text-muted">Gateways Criados</p>
                        </div>
                        <div class="col-md-4">
                            <i class="bi bi-cpu fs-2 text-info"></i>
                            <h4 class="mt-2">{{ dispositivos_recentes }}</h4>
                            <p class="text-muted">Dispositivos Criados</p>
                        </div>
                        <div class="col-md-4">
                            <i class="bi bi-people fs-2 text-primary"></i>
                            <h4 class="mt-2">{{ total_usuarios }}</h4>
                            <p class="text-muted">Usuários Ativos ({{ usuarios_admin }} admins)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <strong><i class="bi bi-lightning me-2"></i>Ações Administrativas</strong>
                </div>
                <div class="card-body">
                    <a href="{% url 'tds_new:admin_certificados_list' %}" class="btn btn-primary me-2 mb-2">
                        <i class="bi bi-shield-check me-2"></i>Gerenciar Certificados
                    </a>
                    <button class="btn btn-secondary me-2 mb-2" disabled>
                        <i class="bi bi-upload me-2"></i>Importar Gateways (CSV) <small>(Week 9)</small>
                    </button>
                    <button class="btn btn-info me-2 mb-2" disabled>
                        <i class="bi bi-file-earmark-text me-2"></i>Logs de Auditoria <small>(Week 9)</small>
                    </button>
                    <button class="btn btn-warning me-2 mb-2" disabled>
                        <i class="bi bi-download me-2"></i>Exportar CRL <small>(Week 9)</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
